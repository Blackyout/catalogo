# Ejemplo 3: Firewall de una LAN con salida a Internet y con servicio Web en la LAN
# ---------------------------------------------------------------------------------
#1) Eliminar Reglas del Firewall
#   ----------------------------
iptables -F
iptables -X
iptables -Z
iptables -t nat -F

#2) Estableciento reglas predeterminadas
#   -----------------------------------
iptables -P INPUT ACCEPT
iptables -P OUTPUT ACCEPT
iptables -P FORWARD ACCEPT
iptables -t nat -P PREROUTING ACCEPT
iptables -t nat -P POSTROUTING ACCEPT

#3) Aplicando reglas de filtrado
#   --------------------------------
# Publicar servidor web
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -j DNAT --to 192.168.10.12:80

# Permitir la administracion del servidor web via terminal server(3389)
iptables -t nat -A PREROUTING -s 221.23.124.181 -i eth0 -p tcp --dport 3389 -j DNAT --to 192.168.10.12:3389

# al localhost se le permite cualquier c onfiguracion
iptables - A INPUT -i lo -j ACCEPT

#Permitir a la LAN el acceso al Firewall
iptables -A INPUT -s 192.168.10.0/24 -i eth1 -j ACCEPT

#Publicar el servidor de Correo.
iptables -A INPUT -s 0.0.0.0/0 -p tcp --dport 25 -j ACCEPT
iptables -A INPUT -s 0.0.0.0/0 -p tcp --dport 110 -j ACCEPT
iptables -A INPUT -s 0.0.0.0/0 -p tcp --dport 143 -j ACCEPT

# Al IP 211.45.176.24 se le permite establecer conexion con la LAN via VPN
iptables -A INPUT -s 211.45.176.24 -p tcp --dport 1723 -j ACCEPT

# Permitir a la LAN el acceso a Internet.
iptables -A FORWARD -s 192.168.10.0/24 -i eth1 -p tcp --dport 80 -j ACCEPT
iptables -A FORWARD -s 192.168.10.0/24 -i eth1 -p tcp --dport 443 -j ACCEPT
iptables -A FORWARD -s 192.168.10.0/24 -i eth1 -p tcp --dport 53 -j ACCEPT
iptables -A FORWARD -s 192.168.10.0/24 -i eth1 -p udp --dport 53 -j ACCEPT

iptables -A FORWARD -s 192.168.10.0/24 -i eth1 -j DROP

# Realizar el enmascaramiento de la LAN.
iptables -t nat -A POSTROUTING -s 192.168.10.0/24 -o eth0 -j MASQUERADE

#4) cERRAR pUERTOS PRIVILEGIADOS
iptables -A INPUT -s 0.0.0.0/0 -i eth0 -p tcp --dport 1:1024 -j DROP
iptables -A INPUT -s 0.0.0.0/0 -i eth0 -p udp --dport 1:1024 -j DROP
iptables -A INPUT -s 0.0.0.0/0 -i eth0 -p tcp --dport 1723 -j DROP
iptables -A INPUT -s 0.0.0.0/0 -i eth0 -p tcp --dport 1000 -j DROP




