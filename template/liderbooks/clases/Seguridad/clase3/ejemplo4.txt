#1) Eliminar Reglas del Firewall
#   ----------------------------
iptables -F
iptables -X
iptables -Z
iptables -t nat -F

#2) Estableciento reglas predeterminadas
#   -----------------------------------
iptables -P INPUT ACCEPT
iptables -P OUTPUT ACCEPT
iptables -P FORWARD ACCEPT
iptables -t nat -P PREROUTING ACCEPT
iptables -t nat -P POSTROUTING ACCEPT

#3) Aplicando reglas de filtrado
#  -----------------------------

# Publicar servidor web.
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -j DNAT --to 192.168.3.2:80
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 443 -j DNAT --to 192.168.3.2:443

# Al localhost se le permite realizar cualquier configuracion
iptables -A INPUT -i lo -j ACCEPT

# Permitir el acceso de la LAN al Firewall
iptables -A INPUT -s 192.168.10.0/24 -i eth1 -j ACCEPT

# Realizar el enmasscararmiento de la LAN y la DMZ
iptables -t nat -A POSTROUTING -s 192.168.10.0/24 -o eth0 -j MASQUERADE
iptables -t nat -A POSTROUTING -s 192.168.3.0/24 -o eth0 -j MASQUERADE

# Permitir al servidor web conectarse al servidoer de BDD de la LAN
ipables -A FORWARD -s 192.168.3.2 -D 192.168.10.5 -p tcp --dport 5432 -j ACCEPT
iptables -A FORWARD -s 192.168.10.5 -d 192.168.3.2 -p tcp -sport 5432 -j ACCEPT

# Permitir a la LAN la admisminstracion del servidor web vioa Terminal Server.
iptables -A FORWARD -s 192.168.10.0/24 -d 192.168.3.2 -p tcp --dport 3389 -j ACCEPT
iptables -A FORWARD -s 192.168.3.2 -d 192.168.10.0/24 -p tcp --sport 3389 -j ACCEPT

#4) Cerrar puertos privilegiados.
#   ----------------------------
iptables -A FORWARD -s 192.168.3.0/24 -d 192.168.10.0/24 -j DROP
iptables -A INPUT -s 192.168.3.0/24 -i eth2 -j DROP
iptables -A INPUT -s 0.0.0.0/0 -p tcp --dport 1:1024 -j DROP
iptables -A INPUT -s 0.0.0.0/0 -p udp --dport 1:1024 -j DROP
iptables -A INPUT -s 0.0.0.0/0 -p tcp --dport 3389 -j DROP
iptables -A INPUT -s 0.0.0.0/0 -p tcp --dport 5432 -j DROP
iptables -A INPUT -s 0.0.0.0/0 -p tcp --dport 10000 -j DROP







